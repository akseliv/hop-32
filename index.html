<script src="/node_modules/phaser-ce/build/phaser.min.js"></script>
<script>
window.onload = function() {
    var game = new Phaser.Game(640, 360, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update });
    var player;
    var cursors;
    function preload() {
        game.load.image('player', 'sprites/player.png');
        game.load.image('TestTiles', 'sprites/test-tiles.png');
        game.load.tilemap('tiles', 'tilemaps/test.json', null, Phaser.Tilemap.TILED_JSON);

    }
    var layer;
    function create() {

        PIXI.scaleModes.DEFAULT = PIXI.scaleModes.NEAREST;
        map = game.add.tilemap('tiles');
        map.addTilesetImage('redbrick', 'TestTiles');
        map.setCollision(1);
        layer = map.createLayer('Tile Layer 1');
        layer.resizeWorld();
        cursors = game.input.keyboard.createCursorKeys();
        game.physics.startSystem(Phaser.Physics.ARCADE);
        player = game.add.sprite(32, 0, 'player');
        player.smoothed = false;
        game.physics.enable(player, Phaser.Physics.ARCADE);
        player.body.collideWorldBounds=true;

    }

    var kcheck = true;
    var heading = {};
    var tween = false;
    var frames = 0;
    var keyDelayFrames = 0;
    var keyDelayFramesCount = -10;
    var frameCount = -10;
    var lastKey = false;
    var lastKeyReleased = false;
    var leapDistance = 32;
    var snapGrid = 32;

    function update() {
        deltaTime = game.time.elapsed/1000;
        game.physics.arcade.collide(player, layer,function(player, layer){
            frames = 0;
        });
        player.body.velocity.x = 0;
        player.body.velocity.y = 0;
        if(cursors.left.isDown && kcheck){
            heading = {x:-1, y: false}
            kcheck = false;
            frames = frameCount;
            keyDelayFrames = keyDelayFramesCount;
            lastKey = cursors.left;
        }

        if(cursors.right.isDown && kcheck){
            heading = {x: 1, y: false}
            kcheck = false;
            frames = frameCount;
            keyDelayFrames = keyDelayFramesCount;
            lastKey = cursors.right;
            console.log("right move");
        }

        if(cursors.up.isDown && kcheck){
            heading = {x: false, y: -1}
            kcheck = false;
            frames = frameCount;
            keyDelayFrames = keyDelayFramesCount;
            lastKey = cursors.up;
        }

        if(cursors.down.isDown && kcheck){
            heading = {x: false, y: 1}
            kcheck = false;
            frames = frameCount;
            keyDelayFrames = keyDelayFramesCount;
            lastKey = cursors.down;
        }
        if(!frames && keyDelayFrames){
            keyDelayFrames++;
        }
        if((lastKey && keyDelayFrames === 0)){
            keyDelayFrames = false;
            kcheck = true;
        }
        if((lastKey.isUp && frames < -3 && !kcheck)){
            keyDelayFrames = false;
            kcheck = true;
            console.log('timed');
        }

        if(frames === 0){
            heading = {};
            player.body.position.x = Math.round(player.body.position.x/snapGrid)*snapGrid;
            player.body.position.y = Math.round(player.body.position.y/snapGrid)*snapGrid;
            frames = false;
            console.log("x:"+player.body.x,"y:"+player.body.y);
        }
        if(typeof heading.x == 'number' && frames < 0){
            player.body.velocity.x = (leapDistance*(60/-frameCount))*60*deltaTime*heading.x;
            frames++;
        }
        if(typeof heading.y == 'number' && frames < 0){
            player.body.velocity.y = (leapDistance*(60/-frameCount))*60*deltaTime*heading.y;
            frames++;
        }

    }

}
</script>
<style>
canvas {
    image-rendering: optimizeSpeed;             /* Older versions of FF          */
    image-rendering: -moz-crisp-edges;          /* FF 6.0+                       */
    image-rendering: -webkit-optimize-contrast; /* Safari                        */
    image-rendering: -o-crisp-edges;            /* OS X & Windows Opera (12.02+) */
    image-rendering: pixelated;                 /* Awesome future-browsers       */
    -ms-interpolation-mode: nearest-neighbor;   /* IE                            */
}
</style>